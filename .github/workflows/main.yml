on:
  workflow_dispatch:
  push:
  pull_request:

name: CI

jobs:
  lint:
    name: Lint All Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get IcarusVerilog
        run: |
          sudo apt-get install -y iverilog
      - name: Verify
        run: |
          cd verification
          for SIZE in $(cat ./.github/workflows/sizes.txt); do
              export PATTERN=tb_RAM$SIZE
              /bin/bash -c "make lint"
          done
  verify_models:
    name: Verify Models
    runs-on: ubuntu-latest
    strategy:
      matrix:
        size:
          [
            "8x32",
            "32x32",
            "128x32",
            "256x32",
            "512x32",
            "1024x32",
            "2048x32",
            "8x32_1RW1R",
            "32x32_1RW1R",
            "128x32_1RW1R",
            "256x32_1RW1R",
            "512x32_1RW1R",
            "1024x32_1RW1R",
            "2048x32_1RW1R",
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get IcarusVerilog
        run: |
          sudo apt-get install -y iverilog
      - name: Run Verification
        run: |
          export PATTERN=tb_RAM${{ matrix.size }}
          cd verification/
          /bin/bash -c "! make | grep -c FATAL"
  harden:
    name: ${{ matrix.count }}x${{ matrix.width }} (${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { count: "32", width: "8", variant: "DEFAULT" }
          # - { count: "32", width: "8", variant: "1RW1R" }
          - { count: "32", width: "16", variant: "DEFAULT" }
          # - { count: "32", width: "16", variant: "1RW1R" }
          - { count: "32", width: "32", variant: "DEFAULT" }
          - { count: "32", width: "32", variant: "2R1W" }
          # - { count: "32", width: "32", variant: "1RW1R" } # Timeout
          - { count: "256", width: "8", variant: "DEFAULT" }
          # - { count: "256", width: "8", variant: "1RW1R" }
          - { count: "256", width: "16", variant: "DEFAULT" }
          # - { count: "256", width: "16", variant: "1RW1R" } # Timeout
          - { count: "256", width: "32", variant: "DEFAULT" }
          #- { count: "256", width: "32", variant: "1RW1R" } # Timeout
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run
        run: |
          pip3 install --upgrade --no-cache-dir -r ./requirements.txt

          building_blocks=ram
          if [ "${{ matrix.variant }}" != "2R1W" ]; then
            building_blocks=rf
          fi

          ./dffram.py\
            -s ${{ matrix.count }}x${{ matrix.width }}\
            -b sky130A:sky130_fd_sc_hd:$building_blocks\
            -v ${{ matrix.variant }}

          echo "PRODUCTS_PATH=$(cat ./products_path)" >> $GITHUB_ENV
      - name: Upload Final Views
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.count }}x${{ matrix.width }}-${{ matrix.variant }}
          path: ${{ env.PRODUCTS_PATH }}
