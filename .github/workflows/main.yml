on:
  workflow_dispatch:
  push:
  pull_request:

name: CI

jobs:
  lint:
    name: Lint All Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get IcarusVerilog
        run: |
          sudo apt-get install -y iverilog
      - name: Verify
        run: |
          cd verification
          for SIZE in $(cat ./.github/workflows/sizes.txt); do
              export PATTERN=tb_RAM$SIZE
              /bin/bash -c "make lint"
          done
  verify_models:
    name: Verify (${{ matrix.count }}x${{ matrix.width }}_${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { count: "8", width: "32", variant: "DEFAULT" }
          - { count: "32", width: "32", variant: "DEFAULT" }
          - { count: "128", width: "32", variant: "DEFAULT" }
          - { count: "256", width: "32", variant: "DEFAULT" }
          - { count: "512", width: "32", variant: "DEFAULT" }
          - { count: "1024", width: "32", variant: "DEFAULT" }
          - { count: "2048", width: "32", variant: "DEFAULT" }
          - { count: "8", width: "32", variant: "1RW1R" }
          - { count: "32", width: "32", variant: "1RW1R" }
          - { count: "128", width: "32", variant: "1RW1R" }
          - { count: "256", width: "32", variant: "1RW1R" }
          - { count: "512", width: "32", variant: "1RW1R" }
          - { count: "1024", width: "32", variant: "1RW1R" }
          - { count: "2048", width: "32", variant: "1RW1R" }
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get IcarusVerilog
        run: |
          sudo apt-get install -y iverilog
      - name: Run Verification
        run: |
          variant_postfix=
          if [ "${{ matrix.variant }}" != "DEFAULT" ]; then
            variant_postfix="_${{ matrix.variant }}"
          fi
          export PATTERN=tb_RAM${{ matrix.count }}x${{ matrix.width }}$variant_postfix
          cd verification/
          /bin/bash -c "! make | grep -c FATAL"
  harden:
    name: Harden (${{ matrix.count }}x${{ matrix.width }}_${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { count: "32", width: "8", variant: "DEFAULT" }
          # - { count: "32", width: "8", variant: "1RW1R" }
          - { count: "32", width: "16", variant: "DEFAULT" }
          # - { count: "32", width: "16", variant: "1RW1R" }
          - { count: "32", width: "32", variant: "DEFAULT" }
          - { count: "32", width: "32", variant: "2R1W" }
          # - { count: "32", width: "32", variant: "1RW1R" } # Timeout
          - { count: "256", width: "8", variant: "DEFAULT" }
          # - { count: "256", width: "8", variant: "1RW1R" }
          - { count: "256", width: "16", variant: "DEFAULT" }
          # - { count: "256", width: "16", variant: "1RW1R" } # Timeout
          - { count: "256", width: "32", variant: "DEFAULT" }
          #- { count: "256", width: "32", variant: "1RW1R" } # Timeout
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run
        run: |
          pip3 install --upgrade --no-cache-dir -r ./requirements.txt

          building_blocks=ram
          if [ "${{ matrix.variant }}" == "2R1W" ]; then
            building_blocks=rf
          fi

          ./dffram.py\
            -s ${{ matrix.count }}x${{ matrix.width }}\
            -b sky130A:sky130_fd_sc_hd:$building_blocks\
            -v ${{ matrix.variant }}

          echo "PRODUCTS_PATH=$(cat ./products_path)" >> $GITHUB_ENV
      - name: Upload Final Views
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.count }}x${{ matrix.width }}-${{ matrix.variant }}
          path: ${{ env.PRODUCTS_PATH }}
