on:
  workflow_dispatch:
  push:
  pull_request:

name: CI

jobs:          
  lint:
    name: Lint on all models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Verify
        run: |
          for SIZE in $(cat ./.github/workflows/sizes.txt)
          do
            export PATTERN=tb_RAM$SIZE
            cd Compiler/verification/
            /bin/bash -c "make lint"
          done
  verify_models:
    name: Verify Models
    runs-on: ubuntu-latest
    strategy:
        matrix:
          size: ["8x32", "32x32", "128x32", "256x32", "512x32", "1024x32", "2048x32",
                "8x32_1RW1R", "32x32_1RW1R", "128x32_1RW1R", "256x32_1RW1R", "512x32_1RW1R",
                "1024x32_1RW1R", "2048x32_1RW1R"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Verify
        run: |
          sudo apt-get install iverilog
          for SIZE in ${{ matrix.size }}
          do
            export PATTERN=tb_RAM$SIZE
            cd Compiler/verification/
            /bin/bash -c "! make | grep -c FATAL"
          done
  test_legacy:
    name: Test (Legacy)
    runs-on: ubuntu-latest
    needs: verify_models
    strategy:
        matrix:
          size: ["8x32", "32x32", "128x32"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Run
        run: |
          cd Compiler/
          ./prflow.py -s ${{ matrix.size }}
  test_experimental:
    name: Test (Experimental)
    runs-on: ubuntu-latest
    strategy:
        matrix:
          count: ["8", "32"]
          width: ["8", "16", "32"] # 64 temporarily removed (crashes)
          variant: ["DEFAULT", "1RW1R"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Run
        run: |
          cd Compiler/
          ./prflow.py -s ${{ matrix.count }}x${{ matrix.width }} -b sky130A:experimental -v ${{ matrix.variant }}
